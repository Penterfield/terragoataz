steps:
- task: NodeTool@0
  inputs:
    versionSpec: '10.x'
  displayName: Install NodeJS

- script: |
    npm install
    npm test
  displayName: NPM Install and Test

- task: SnykSecurityScan@0
  displayName: 'Snyk IaC Security Scan'
  inputs:
    serviceConnectionEndpoint: 'Snyk'
    script: |
      mkdir snyk
      snyk iac test --severity-threshold=high --json-file-output=snyk/iac-results.json
      exitCode=$?
      [[ $exitCode = 0 ]] && state="success" || state="failure"
      echo "##vso[task.setvariable variable=SnykScaState;]$state"
      exit $exitCode


