steps:
- task: NodeTool@0
  inputs:
    versionSpec: '10.x'
  displayName: Install NodeJS
  
- script: |
    npm install -g snyk
  displayName: Install Snyk CLI

- script: |
    python -m pip install --upgrade pip
    pip install cucumber-json-to-junit-xml
  displayName: Install dependencies

- script: |
    snyk config set api=$(SNYK_TOKEN)
    snyk iac test --severity-threshold=medium --json > snyk_iac_results.json
    sudo json_to_junit snyk_iac_results.json snyk_iac_results.xml
  displayName: Snyk IaC Security Scan

- task: PublishTestResults@2
  displayName: Publish Snyk IaC Test Results
  condition: succeededOrFailed()
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/snyk_iac_results.xml'
    mergeTestResults: true
    failTaskOnFailedTests: false
    testRunTitle: 'Snyk IaC Vulnerabilities'
   

 
